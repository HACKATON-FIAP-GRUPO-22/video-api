name: Build and Push Docker Image

on:
  push:
    branches:
      - test_copu

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18  

    - name: Install Dependencies
      run: npm install
  
    - name: Run Tests
      run: npm test  
    
    - name: Copy test artifacts with timestamp
      run: |
        TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
        DEST_DIR="test-reports/$TIMESTAMP"
        
        # Criar diretório de destino
        mkdir -p "$DEST_DIR"
        
        # Copiar os arquivos
        cp -r /home/runner/work/video-api/video-api/coverage/* "$DEST_DIR"
    
        echo "Artifacts copied to $DEST_DIR"
    
    - name: Commit and push changes
      run: |
        git config --global user.email "edsontecno@gmail.com"
        git config --global user.name "GitHub Actions"
        
        # Adiciona os arquivos ao git
        git add test-reports/
        
        # Comita as mudanças, ignorando erros se não houver mudanças
        git commit -m "Add mochawesome test reports - $(date)" || echo "No changes to commit"
        
        # Faz push para o branch atual
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}  